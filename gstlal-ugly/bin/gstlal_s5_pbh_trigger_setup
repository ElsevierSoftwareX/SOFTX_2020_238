#!/usr/bin/env python
#
# Copyright (C) 2011 Chad Hanna
#
# This program is free software; you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by the
# Free Software Foundation; either version 2 of the License, or (at your
# option) any later version.
#
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General
# Public License for more details.
#
# You should have received a copy of the GNU General Public License along
# with this program; if not, write to the Free Software Foundation, Inc.,
# 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.

import sys
import os
import socket

def web_path():
	host = socket.getfqdn()
	#FIXME add more hosts as you need them
	if 'cit' in host or 'caltech.edu' in host: return '/archive/home/' + os.environ['USER'] + "/public_html"
	if 'phys.uwm.edu' in host: return '/home/' + os.environ['USER'] + "/public_html" 
	if 'phy.syr.edu' in host: return '/archive/home/' + os.environ['USER'] + "/public_html"
	raise NotImplementedError, "this cluster web space is not known, please add to this script"
	
# S5 began on 815155213 - Fri Nov 04 16:00:00 GMT 2005
# S5 ended on 875232014 - Mon Oct 01 00:00:00 GMT 2007
# This program returns the GPS boundaries that approximately correspond to commissioning breaks during this time starting with 815504413 - Tues Nov 08 12:00:00 EST 2005

prog = os.path.split(sys.argv[0])[1]

if len(sys.argv) != 3 and len(sys.argv) != 4:
	print >>sys.stderr, "usage:\n\t%s <week (int)> <path to bank dir>\n\t%s <gps start (int)> <gps end (int)> <path to bank dir>" % (prog,prog)
	sys.exit()

if len(sys.argv) == 3:
	week = int(sys.argv[1])
	path = os.path.abspath(sys.argv[2])

	if week < 1 or week > 98:
		print >>sys.stderr, "week must be between 1 and 98"
		sys.exit(1)

	start = 815504413 + (week - 1) * 604800
	end = 815504413 + (week) * 604800

if len(sys.argv) == 4:
	week = 1
	path = os.path.abspath(sys.argv[3])
	start = int(sys.argv[1])
	end = int(sys.argv[2])

print >>sys.stderr, "\n\tmaking directory for ", start, end

dir = "%d-%d" % (start, end)
os.mkdir("%d-%d" % (start, end))

f = open("%s/Makefile" % (dir,) , "w")
f.write("START = %d\n" % (start,))
f.write("STOP = %d\n" % (end,))
f.write("PSD_FILE = %s/reference_psd.xml.gz\n" % (path,))
f.write("CLUSTER_SQL_FILE = %s/simplify_and_cluster.sql\n" % (path,))
f.write("INJ_SQL_FILE = %s/inj_simplify_and_cluster.sql\n" % (path,))
f.write("H1_BANK_CACHE = %s/H1_bank.cache\n" % (path,))
f.write("H2_BANK_CACHE = %s/H2_bank.cache\n" % (path,))
f.write("L1_BANK_CACHE = %s/L1_bank.cache\n" % (path,))
f.write("SEED = %d\n" % (week,))
f.write("WEBDIR = %s/sub-solar-mass-%d-%d\n" % (web_path(), start, end))
f.write("""
MIN_DIST = 770
MAX_DIST = 10000
MIN_MASS1 = 0.2
MAX_MASS1 = 1.8
MIN_MASS2 = 0.2
MAX_MASS2 = 1.0
MIN_TOTAL_MASS = 0.4
MAX_TOTAL_MASS = 1.8
FLOW = 39
TRIM = 16

all : injections

tisi.xml :
	ligolw_tisi --instrument=H1=0:0:0 --instrument=H2=0:0:0 --instrument=L1=0:3.14159:3.14159 tisi.xml

dag : vetoes.xml segments.xml frame.cache tisi.xml web
	gstlal_s5_pbh_trigger_pipe --gps-start-time $(START) --gps-stop-time $(STOP) --reference-psd $(PSD_FILE) --frame-cache frame.cache --frame-segments-file segments.xml  --frame-segments-name datasegments --bank-cache H1=$(H1_BANK_CACHE),H2=$(H2_BANK_CACHE),L1=$(L1_BANK_CACHE) --vetoes vetoes.xml --time-slide-file tisi.xml --cluster-sql-file $(CLUSTER_SQL_FILE) --web-dir $(WEBDIR) --control-peak-time 4 --fir-stride 4 --num-banks 4

injections : vetoes.xml segments.xml frame.cache injections.xml web tisi.xml
	gstlal_s5_pbh_trigger_pipe --injections injections.xml --gps-start-time $(START) --gps-stop-time $(STOP) --reference-psd $(PSD_FILE) --frame-cache frame.cache --frame-segments-file segments.xml --frame-segments-name datasegments --bank-cache H1=$(H1_BANK_CACHE),H2=$(H2_BANK_CACHE),L1=$(L1_BANK_CACHE) --vetoes vetoes.xml --cluster-sql-file $(CLUSTER_SQL_FILE) --injection-sql-file $(INJ_SQL_FILE) --web-dir $(WEBDIR) --time-slide-file tisi.xml --control-peak-time 4 --fir-stride 4 --num-banks 4

H1vetoes.xml:
	ligolw_segment_query --segment-url=https://metaserver.phy.syr.edu -q --gps-start-time ${START} --gps-end-time ${STOP} --include-segments=H1:Injection --result-name=vetoes > H1vetoes.xml
	ligolw_segments_compat H1vetoes.xml

H2vetoes.xml:
	ligolw_segment_query --segment-url=https://metaserver.phy.syr.edu -q --gps-start-time ${START} --gps-end-time ${STOP} --include-segments=H2:Injection --result-name=vetoes > H2vetoes.xml
	ligolw_segments_compat H2vetoes.xml

L1vetoes.xml:
	ligolw_segment_query --segment-url=https://metaserver.phy.syr.edu -q --gps-start-time ${START} --gps-end-time ${STOP} --include-segments=L1:Injection --result-name=vetoes > L1vetoes.xml
	ligolw_segments_compat L1vetoes.xml

H1segmentspadded.xml:
	ligolw_segment_query --segment-url=https://metaserver.phy.syr.edu -q --gps-start-time ${START} --gps-end-time ${STOP} --include-segments=H1:Science  --result-name=datasegments > H1segments.xml
	ligolw_segments_compat H1segments.xml
	gstlal_s5_pbh_segments_trim H1segments.xml $(TRIM) H1segmentspadded.xml

H2segmentspadded.xml:
	ligolw_segment_query --segment-url=https://metaserver.phy.syr.edu -q --gps-start-time ${START} --gps-end-time ${STOP} --include-segments=H2:Science --result-name=datasegments > H2segments.xml
	ligolw_segments_compat H2segments.xml
	gstlal_s5_pbh_segments_trim H2segments.xml $(TRIM) H2segmentspadded.xml

L1segmentspadded.xml:
	ligolw_segment_query --segment-url=https://metaserver.phy.syr.edu -q --gps-start-time ${START} --gps-end-time ${STOP} --include-segments=L1:Science --result-name=datasegments > L1segments.xml
	ligolw_segments_compat L1segments.xml
	gstlal_s5_pbh_segments_trim L1segments.xml $(TRIM) L1segmentspadded.xml

vetoes.xml: H1vetoes.xml H2vetoes.xml L1vetoes.xml
	ligolw_add H1vetoes.xml H2vetoes.xml L1vetoes.xml > vetoes.xml

frame.H1.cache:
	ligo_data_find -o H -t H1_RDS_C03_L2 -l  -s $(START) -e $(STOP) --url-type file > frame.H1.cache

frame.H2.cache:
	ligo_data_find -o H -t H2_RDS_C03_L2 -l  -s $(START) -e $(STOP) --url-type file > frame.H2.cache

frame.L1.cache:
	ligo_data_find -o L -t L1_RDS_C03_L2 -l  -s $(START) -e $(STOP) --url-type file > frame.L1.cache

frame.cache: frame.H1.cache frame.H2.cache frame.L1.cache
	cat frame.H1.cache frame.H2.cache frame.L1.cache > frame.cache

segments.xml: H1segmentspadded.xml H2segmentspadded.xml L1segmentspadded.xml
	ligolw_add --output segments.xml H1segmentspadded.xml H2segmentspadded.xml L1segmentspadded.xml
	ligolw_cut --delete-column segment:segment_def_cdb --delete-column segment:creator_db --delete-column segment_definer:insertion_time segments.xml

injections.xml:
	lalapps_inspinj \\
		--output injections.xml \\
		--seed $(SEED) \\
		--f-lower $(FLOW) \\
		--gps-start-time $(START) \\
		--gps-end-time $(STOP) \\
		--t-distr uniform \\
		--time-step 100 \\
		--time-interval 20 \\
		--i-distr uniform \\
		--l-distr random \\
		--d-distr log10 \\
		--min-distance $(MIN_DIST) \\
		--max-distance $(MAX_DIST) \\
		--m-distr componentMass \\
		--min-mass1 $(MIN_MASS1) \\
		--max-mass1 $(MAX_MASS1) \\
		--min-mass2 $(MIN_MASS2) \\
		--max-mass2 $(MAX_MASS2) \\
		--min-mtotal $(MIN_TOTAL_MASS) \\
		--max-mtotal $(MAX_TOTAL_MASS) \\
		--waveform GeneratePPNthreePointFivePN \\
		--taper-injection start \\
		--disable-spin

web :
	mkdir plots
	mkdir $(WEBDIR) 

realclean :
	rm -r plots $(WEBDIR) *.sub *.dag* *.cache *.sh logs *.xml *.gz *.sqlite *.html *.css *.js Images
""")
f.close()

print >>sys.stderr, "\n\tcd into %s and run make.  Then do condor_submit_dag -maxidle 100 trigger_pipe.dag\n" % (dir,)
