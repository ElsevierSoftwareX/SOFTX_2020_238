#!/usr/bin/python

import os,sys
import cgi
import cgitb
cgitb.enable()
form = cgi.parse()
import time

gps = "-1"
duration = "600"
if "GPS" in form:
	gps = form["GPS"][0]
if "Duration" in form:
	duration = form["Duration"][0]
if gps != "-1":
	refresh = 1000000
	longrefresh = 1000000
else:
	refresh = 5
	longrefresh = 30

print "Content-type: text/html"
print "Cache-Control: max-age=10"
print

print '''
<html>
<head>
	<title>gstlal CBC Latency</title>
	<link rel="stylesheet" type="text/css" href="../gstlal.css">
	<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
	<script type="text/javascript" src="../jquery-3.1.1.min.js"></script>
	<script type="text/javascript" src="../gstlal.js"></script>
	<script type="text/javascript">
	google.charts.load('current', {'packages':['corechart', 'table']});
'''

print "	google.charts.setOnLoadCallback(function(){ drawLatencyStatusByNodes(%s,%s,%d) });" % (gps, duration, longrefresh)
print "	google.charts.setOnLoadCallback(function(){ drawLatencyHistory(%s,%s,%d) });" % (gps, duration, longrefresh)
print "	google.charts.setOnLoadCallback(function(){ drawLatencyGauge(%s,%s,%d) });" % (gps, duration, longrefresh)
print ""
print "	google.charts.setOnLoadCallback(function(){ drawSNRStatusByNodes(%s,%s,%d) });" % (gps, duration, longrefresh)
print "	google.charts.setOnLoadCallback(function(){ drawSNRHistory(%s,%s,%d) });" % (gps, duration, longrefresh)
print ""
print "	google.charts.setOnLoadCallback(function(){ drawHorizon(%s,%s,%d) });" % (gps, duration, refresh)
print "	google.charts.setOnLoadCallback(function(){ drawNoise(%s,%s,%d) });" % (gps, duration, refresh)
print "	google.charts.setOnLoadCallback(function(){ drawPSD(%s,%s,%d) });" % (gps, duration, refresh)
print "	google.charts.setOnLoadCallback(function(){ drawNoiseGauge(%s,%s,%d) });" % (gps, duration, refresh)
print "	google.charts.setOnLoadCallback(function(){ drawRangeGauge(%s,%s,%d) });" % (gps, duration, refresh)

print '''
	</script>
</head>

<body>
	<form>
	<!-- <div class=topbox> -->
		<ul class="tab">
			<li><img style="width: 100px; margin: 5px 5px 5px 5px;" src="http://www.lsc-group.phys.uwm.edu/cgit/gstlal/plain/gstlal/doc/gstlal.png"></li>
			<!-- <li><a href="#ldg" class="tablinks" onclick="openGstlalTab(event, 'LDG')">LDG</a></li> -->
			<li><a href="#dashboard" class="tablinks" onclick="openGstlalTab(event, 'Dashboard', noise_gauge_wrapper, latency_gauge_wrapper, range_gauge_wrapper)">Dashboard</a></li>
			<!-- <li><a href="#events" class="tablinks" onclick="openGstlalTab(event, 'Events')">Events</a></li> -->
			<li><a href="#detchar" class="tablinks" onclick="openGstlalTab(event, 'Detchar')">Detchar</a></li>
			<li><a href="#logs" class="tablinks" onclick="openGstlalTab(event, 'Logs')">Logs</a></li>
			<li><a href="#noise" class="tablinks" onclick="openGstlalTab(event, 'Noise', noise_wrapper)">Noise</a></li>
			<li><a href="#sens" class="tablinks" onclick="openGstlalTab(event, 'Sensitivity', horizon_wrapper, psd_wrapper)">Sensitivity</a></li>
			<li><a href="#latency" class="tablinks" onclick="openGstlalTab(event, 'Latency', latency_status_by_nodes_wrapper, latency_history_wrapper)">Latency</a></li>
			<li><a href="#snr" class="tablinks" onclick="openGstlalTab(event, 'SNR', snr_status_by_nodes_wrapper, snr_history_wrapper)">SNR</a></li>
			<li>
'''				
print '			<input type="text" name="GPS" value="%s" size=8 style="margin: 7px 5px 5px 5px;"><input type="submit" value="GPS" style="margin: 7px 5px 5px 5px;">' % (gps,)
print '			<input type="text" name="Duration" value="%s" size=4 style="margin: 7px 5px 5px 5px;">' % (duration,)
print '			<input type="submit" value="Duration" style="margin: 7px 5px 5px 5px;">'
print '''			
			</li>
			<div id="clock" style="text-align: right; margin: 7px 5px 5px 5px;"></div>
		</ul>
	<!-- </div> -->
	</form>

	<!--
	<div id="LDG" class="tabcontent">
		<iframe src="https://monitor.ligo.org/gwstatus" width=100% height=675></iframe>
	</div>
	-->

	<div id="Dashboard" class="tabcontent">
		<div id="noise_gauge_wrapper"></div>
		<div id="range_gauge_wrapper"></div>
		<div id="latency_gauge_wrapper"></div>
	</div>

	<div id="Logs" class="tabcontent">
		<table width=100%>
			<tr><td><iframe src="https://alog.ligo-wa.caltech.edu/aLOG/iframeSrc.php?authExpired=&content=1&step=&callRep=&startPage=&preview=&printCall=&callUser=&addCommentTo=&callHelp=&callFileType=#&reportSection=8&reportTask=General" width=100% height=675></iframe></td>
			<td><iframe src="https://alog.ligo-la.caltech.edu/aLOG/iframeSrc.php?authExpired=&content=1&step=&callRep=&startPage=&preview=&printCall=&callUser=&addCommentTo=&callHelp=&callFileType=#&reportSection=6&reportTask=General" width=100% height=675></iframe></td></tr>
		</table>
	</div>

	<div id="Detchar" class="tabcontent">
'''

if gps =="-1":
	print '''		<iframe src="https://ldas-jobs.ligo.caltech.edu/~detchar/summary/" width=100% height=675></iframe>'''
else: 
	date = "%04d%02d%02d" % time.gmtime(int(gps)+ 315964785)[0:3]
	print '''		<iframe src="https://ldas-jobs.ligo.caltech.edu/~detchar/summary/day/%s/" width=100%% height=675></iframe>''' % (date,)

print '''
	</div>

	<!--
	<div id="Events" class="tabcontent">
		<iframe src="https://gracedb.ligo.org/latest/?query=gstlal" width=100% height=675></iframe>
	</div>
	-->

	<div id="Noise" class="tabcontent">
		<div id="noise_wrapper"></div>
		<div id="noise_table_wrapper"></div>
	</div>

	<div id="Sensitivity" class="tabcontent">
		<div id="horizon_wrapper"></div>
		<div id="psd_wrapper"></div>
		<div id="horizon_table_wrapper"></div>
	</div>

	<div id="Latency" class="tabcontent">
		<div id="latency_status_by_nodes_wrapper"></div>
		<div id="latency_history_wrapper"></div>
	</div>

	<div id="SNR" class="tabcontent">
		<div id="snr_status_by_nodes_wrapper"></div>
		<div id="snr_history_wrapper"></div>
	</div>
</body>
</html>
'''
